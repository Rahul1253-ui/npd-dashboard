<script>
const ADMIN_PASSWORD="admin123";
const LOGIN_KEY="npd_logged";
const GOOGLE_URL="https://script.google.com/macros/s/AKfycbxTMs1x1cThisNe7LOPtTDrKM_5cKrUJZ3Zz5-ZUbTwz8gqs3-H_zUoZU0GqOY6YkRU/exec";

const tbody=document.getElementById("tbody");

/* LOGIN */
function login(){
 if(password.value===ADMIN_PASSWORD){
  localStorage.setItem(LOGIN_KEY,"yes");
  showApp();
 }else error.innerText="Wrong password";
}
function logout(){
 localStorage.removeItem(LOGIN_KEY);
 location.reload();
}
function showApp(){
 loginBox.style.display="none";
 app.style.display="block";
}
if(localStorage.getItem(LOGIN_KEY)==="yes") showApp();

/* CELLS */
function activityCell(){
 return `<div class="activity" onclick="openCal(this)"></div>
         <input type="date" class="hidden-date" onchange="saveDate(this)">`;
}
function progressCell(){
 return `<div class="progress-box">
          <div class="progress-bar"></div>
          <div class="progress-text">0%</div>
         </div>`;
}

/* ADD ROW */
function addRow(){
 let r=tbody.insertRow();
 r.innerHTML=`
 <td></td>
 <td contenteditable></td>
 <td contenteditable></td>
 <td><input type="date"></td>
 <td>${activityCell()}</td>
 <td>${activityCell()}</td>
 <td>${activityCell()}</td>
 <td>${activityCell()}</td>
 <td>${activityCell()}</td>
 <td>${activityCell()}</td>
 <td>${progressCell()}</td>
 <td>
  <select onchange="updateStatus(this)">
   <option>Open</option>
   <option>In Process</option>
   <option>Closed</option>
  </select>
 </td>
 <td contenteditable></td>
 <td><button onclick="this.closest('tr').remove();refresh()">ðŸ—‘</button></td>`;
 refresh();
}

/* DATE */
function openCal(div){
 let i=div.nextElementSibling;
 i.showPicker?i.showPicker():i.click();
}
function saveDate(i){
 let box=i.previousElementSibling;
 let items=[...box.querySelectorAll("div")];
 items.forEach(x=>x.classList.add("old"));
 let tag=items.length===0?"P":"R"+items.length;
 let d=document.createElement("div");
 d.innerText=`${tag}: ${i.value}`;
 box.appendChild(d);
 updateProgress(i.closest("tr"));
}

/* PROGRESS */
function updateProgress(r){
 let c=0;
 for(let i=4;i<=9;i++)
  if(r.cells[i].querySelector(".activity").innerText.trim()) c++;
 let p=Math.round(c/6*100);
 r.querySelector(".progress-bar").style.width=p+"%";
 r.querySelector(".progress-text").innerText=p+"%";
}

/* STATUS */
function updateStatus(s){
 let r=s.closest("tr");
 r.className="";
 r.classList.add("status-"+s.value.replace(" ","-").toLowerCase());
 refresh();
}

/* SAVE TO GOOGLE SHEET */
function saveData(){
 let data=[];
 [...tbody.rows].forEach(r=>{
  data.push({
   project:r.cells[1].innerText,
   part:r.cells[2].innerText,
   enquiry:r.cells[3].children[0].value,
   feasibility:r.cells[4].querySelector(".activity").innerText,
   rmOrder:r.cells[5].querySelector(".activity").innerText,
   rmTest:r.cells[6].querySelector(".activity").innerText,
   plan:r.cells[7].querySelector(".activity").innerText,
   docs:r.cells[8].querySelector(".activity").innerText,
   final:r.cells[9].querySelector(".activity").innerText,
   status:r.cells[11].children[0].value,
   remarks:r.cells[12].innerText
  });
 });

 fetch(GOOGLE_URL,{
  method:"POST",
  body:JSON.stringify(data),
  mode:"no-cors"
 });

 alert("âœ… Data saved to Google Sheet");
}

/* DASHBOARD */
function refresh(){
 [...tbody.rows].forEach((r,i)=>r.cells[0].innerText=i+1);
 dashboard();
}
function dashboard(){
 let o=0,p=0,c=0;
 [...tbody.rows].forEach(r=>{
  let v=r.cells[11].children[0].value;
  if(v==="Open")o++; else if(v==="In Process")p++; else c++;
 });
 total.innerText=o+p+c;
 open.innerText=o; process.innerText=p; closed.innerText=c;
}
function filterStatus(s){
 [...tbody.rows].forEach(r=>{
  let v=r.cells[11].children[0].value;
  r.style.display=(s==="All"||v===s)?"":"none";
 });
}
</script>
